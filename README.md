# Todorima – Optimal Reminde（Chrome 拡張 / Manifest V3）

単発／繰り返し／スヌーズ／完了／一覧／検索／同期／スリープ中に過ぎた予定の再通知に対応したタスク管理型のデスクトップ通知リマインダー拡張（MVP）。ポップアップは Atlassian Design を参考に、カード・チップ・タブ構成で一覧性を高めています。

## 特長（MVP）

- タスク作成：タイトル、メモ、期日/時刻、優先度、タグ
- 繰り返し：毎日 / 毎週（曜日指定）/ 毎月（間隔あり）
- 通知アクション：完了 / スヌーズ（既定はオプションで変更可）
- 一覧・編集・削除・検索・並び替え（期日昇順/優先度）
- 同期ストレージ（`chrome.storage.sync`）
- スリープ中に見逃した予定を復帰後に再通知（個別上限＋サマリー）
- 再起動・復帰時の再スケジュール（直近1件の `chrome.alarms`）
- 完了タスクの自動削除（保持日数は設定で変更可）

## インストール手順

1. 本リポジトリをローカルに取得し、`reminder-ext/` ディレクトリを Chrome の `chrome://extensions` で「デベロッパーモード」をオン → 「パッケージ化されていない拡張機能を読み込む」から選択。
2. 拡張のポップアップからタスクを追加し、動作を確認。

補足（ストアからのインストールができない環境でも）

- Chrome ウェブストアにアクセスできない、またはストア経由のインストールが許可されていない端末でも、上記の「デベロッパーモードでのローカル読み込み」で利用できます（Edge/Brave など Chromium 系でも同様）。
- ただし、組織ポリシーで「拡張機能そのもの」が禁止されている場合は利用できません。管理者の許可が必要です。

## 使い方

- アイコンをクリック → ポップアップでタスクを作成。
- `datetime-local` で期日を設定し、必要に応じて繰り返し（毎日/毎週/毎月）を選択。毎週は曜日の複数選択に対応。
- 通知のアクションで「完了」または「スヌーズ(+既定分)」。
- オプションページでスヌーズ分数、通知保持（自動クローズしない）、週開始曜日、再通知の対象期間（時間）、個別再通知の上限を調整可能。
- 「テーマ（ライト/ダーク/システム）」を選択可能。完了セクションの折りたたみ既定や、完了タスクの自動削除（保持日数）も設定できます。

## スリープ中に過ぎた予定の再通知の仕組み

- `lastCheckedAt` を `storage.local` に保存。
- 復帰/起動時（`onStartup`/`onInstalled`/`idle.onStateChanged(active)`）・遅延アラーム発火時（`alarms.onAlarm`）に `catchUp()` を実行。
- `lastCheckedAt < dueAt <= now` の範囲で、見逃した予定を復帰後に通知。個別通知は設定上限までで、超過分はサマリー通知。
- 繰り返しタスクはロールフォワード（`nextOccurrence()` で `dueAt` を次回へ更新）。
- 最後に `lastCheckedAt = now` に更新 → `rehydrateAll()` で直近1件のアラームを再設定。

## 完了タスクの自動削除

- 設定で指定した保持日数（既定: 30日）を過ぎた完了タスクを自動的に削除します。
- 0 日に設定すると自動削除は無効になります。

## データモデル（JSDoc）

`utils/time.js` と `service_worker.js` に JSDoc を記載。

## 技術メモ

- MV3 / ES Modules。`background.service_worker` は `type: "module"` を指定。
- 直近1件のみ `chrome.alarms.create` で登録し、発火時に次を登録する方針。
- 時刻はローカルタイムで扱い、保存は epoch ms。
- `chrome.notifications` ボタンで完了/スヌーズを処理。

## 既知の制約（MVP）

- アイコン画像はプレースホルダー（単色小画像）。必要に応じ差し替え推奨。
- 通知音は未実装（将来 offscreen + Audio を検討）。

## 小ネタ

- ToDoとかけて、トド（海獣）のアイコンを採用しています。かわいくて忘れにくい、そんな体験を目指しています。（実装上は軽量PNGを同梱。お好みで差し替え可能です）

## テスト手順（受け入れ観点）

- ポップアップからタスク追加 → 通知が期日に表示されること。
- 繰り返し（毎日/毎週/毎月）で次回が正しく計算されること（`utils/time.js`）。
- 通知の「完了」でタスクが完了済になる／「スヌーズ」で `dueAt` が延長される。
- ブラウザ再起動後も `rehydrateAll()` により直近1件のアラームが再設定される。
- PC スリープ→復帰で `catchUp()` が見逃し分を再通知し、上限超過分はサマリー通知になる。
- オプションの変更が反映される（スヌーズ分数、通知保持、再通知の対象期間/上限）。
- `chrome.storage.sync` 経由でタスク/設定が保持される。

---

変更理由の要約:

- Manifest V3 + ES Modules で拡張の最小完全版（MVP）を実装。
- サービスワーカーにスケジュール・見逃し再通知・通知処理を集約し、直近1件のみアラーム登録でドリフトを最小化。
- UI（ポップアップ/オプション）を簡潔に実装し、同期ストレージと連携。
